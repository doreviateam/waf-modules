<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View -->
    <record id="view_sale_order_form_inherit_waf_soo" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.waf.soo</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Champs requis pour les domaines -->
            <xpath expr="//form" position="inside">
                <field name="company_id" invisible="1"/>
            </xpath>

            <!-- Masquer le bouton de livraison si la commande n'est pas confirmée -->
            <xpath expr="//button[@name='action_view_delivery']" position="attributes">
                <attribute name="invisible">state not in ('sale', 'done')</attribute>
            </xpath>

            <!-- Ajout du mode de livraison dans l'en-tête -->
            <xpath expr="//field[@name='partner_id']" position="before">
                <field name="delivery_mode"
                       string="Mode de livraison"
                       readonly="state not in ('draft', 'sent')"
                       widget="radio"
                       options="{'horizontal': true}"/>
            </xpath>

            <!-- Ajout des informations de dispatch dans les lignes de commande -->
            <xpath expr="//field[@name='order_line']/tree//field[@name='price_subtotal']" position="after">
                <field name="dispatch_required" optional="hide"/>
                <field name="dispatch_state" readonly="1" optional="hide" 
                       decoration-info="dispatch_state == 'to_dispatch'"
                       decoration-warning="dispatch_state == 'partial'"
                       decoration-success="dispatch_state == 'dispatched'"
                       decoration-danger="dispatch_state == 'error'"/>
                <field name="remaining_qty_to_dispatch" readonly="1" optional="hide" 
                       invisible="not dispatch_required"/>
            </xpath>

            <!-- Ajout d'un onglet pour les dispatches -->
            <xpath expr="//notebook" position="inside">
                <page string="Dispatches" name="dispatches" invisible="delivery_mode == 'standard'">
                    <field name="order_line" domain="[('dispatch_required', '=', True)]" readonly="state not in ('draft', 'sent')">
                        <tree editable="bottom" decoration-info="dispatch_state == 'to_dispatch'"
                              decoration-warning="dispatch_state == 'partial'"
                              decoration-success="dispatch_state == 'dispatched'"
                              decoration-danger="dispatch_state == 'error'">
                            <field name="product_id"/>
                            <field name="name"/>
                            <field name="product_uom_category_id" invisible="1"/>
                            <field name="product_uom_qty"/>
                            <field name="product_uom" groups="uom.group_uom"/>
                            <field name="dispatch_state"/>
                            <field name="remaining_qty_to_dispatch"/>
                            <field name="dispatch_ids" widget="many2many_tags"/>
                            <field name="company_id" invisible="1"/>
                        </tree>
                    </field>
                </page>
            </xpath>

            <!-- Le bouton standard est masqué si on est en mode dispatch -->
            <xpath expr="//button[@name='action_confirm']" position="attributes">
                <attribute name="string">Confirmer</attribute>
            </xpath>
        </field>
    </record>

    <!-- Tree View -->
    <record id="view_sale_order_tree_inherit_waf_soo" model="ir.ui.view">
        <field name="name">sale.order.tree.inherit.waf.soo</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <field name="state" position="before">
                <field name="delivery_mode" optional="show"/>
            </field>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_sale_order_search_inherit_waf_soo" model="ir.ui.view">
        <field name="name">sale.order.search.inherit.waf.soo</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.sale_order_view_search_inherit_quotation"/>
        <field name="arch" type="xml">
            <filter name="sales" position="after">
                <separator/>
                <filter string="Mode Standard" name="standard_mode" domain="[('delivery_mode', '=', 'standard')]"/>
                <filter string="Mode Dispatch" name="dispatch_mode" domain="[('delivery_mode', '=', 'dispatch')]"/>
            </filter>
            <filter name="customer" position="after">
                <filter string="Mode de livraison" name="delivery_mode" context="{'group_by': 'delivery_mode'}"/>
            </filter>
        </field>
    </record>
</odoo>